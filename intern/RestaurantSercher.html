<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <title>RestaurantSercher</title>
    <link href="css/stylesheet.css" rel="stylesheet" type="text/css">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script type="text/javascript" src="jquery-3.1.1.min.js"></script>
    <script src="bootjs/bootstrap.min.js"></script>
  </head>
  <body>
      <div class="page-header">
        <h1>RestaurantSercher</h1>
        <p>~レストラン検索サービス~</p>
      </div>
      <label>検索半径</label>
          <select name="range" class="range" onChange="Serachrange(this);">
            <option value="1">300</option>
            <option value="2">500</option>
            <option value="3">1000</option>
            <option value="4">2000</option>
            <option value="5">3000</option>
          </select>m
      <button class="btn btn-primary btn-lg btn-block serach" type="button" onclick="Serach(0)">検索</button>
      <hr>
      <p id="total">
      </p>
      <div id="maps"></div>
      <div id="result">
      </div>
      <div class="paging">
        <p>
        <input type='button' value='<<' id='back' onclick='Serach(-1)'>
        <span class="currentpoint"></span>ページ/<span class="totalpoint"></span>ページ
        <input type='button' value='>>' id='next' onclick='Serach(1)'>
        </p>
      </div>
    <script>
    //半径を格納する変数 （初期値は半径300m）
    var ran = 1;
    //現在のページを表示する
    var currentpage = 1;
    //経度、緯度
    var lng;
    var lat;

    function Serachrange(obj){
      var idx = obj.selectedIndex;
      ran= obj.options[idx].value;
      // alert(ran);
    }
    function Serach(n){
      if(n == 0){   //検索ボタンクリック時の処理
        currentpage = 1;
        $('#back').css('visibility', 'hidden');
      }
      else{           //next,backクリック時の処理
        currentpage = currentpage + n;
        $('#back').css('visibility', 'visible');
      }
      // Geolocation APIの呼び出し
      navigator.geolocation.getCurrentPosition(function(pos) {
          lat = pos.coords.latitude;
          lng = pos.coords.longitude;
          // ぐるなびAPIの呼び出し
          $.get(
            'http://api.gnavi.co.jp/RestSearchAPI/20150630/',
            {
              keyid: '88552a7d53b8c1e778800023b828199a',
              format: 'json',
              latitude: lat,
              longitude: lng,
              range: ran,
              offset_page: currentpage

            },
            function(response) {
              // ぐるなびAPIの読み込み
              var results = response
              $('#result').empty();
              $('#total').text("検索件数" + results.total_hit_count + "件");
              var totalpoint = Math.floor(results.total_hit_count / 10);

              if(results.total_hit_count % 10 != 0){
                totalpoint++
              }

              $('.totalpoint').text(totalpoint);  //総ページ数の表示
              $('.currentpoint').text(currentpage); //現在のページ番号
              $('.paging').css('visibility' , 'visible'); //ページング表示

              if(currentpage == totalpoint){　//最後のページを読み込んだときの処理
                $('#next').css('visibility' , 'hidden');
              }
              else{
                $('#next').css('visibility' , 'visible');
              }

              if(currentpage == 1){ //最初のページを読み込んだときの処理
                $('#back').css('visibility' , 'hidden');
              }
              else{
                $('#back').css('visibility' , 'visible');
              }

              for (var i = 0; i <= results.rest.length; i++) {
                var result = results.rest[i];
               $('#result').append($('<div class ="resultbox"></div>').append($('<h2 class="name"></h2>').append($('<a></a>').text(result.name).attr({'href': result.url , 'target' : "_blank"})))
                .append($('<p class="access"></p>').text(result.access.line + result.access.station + result.access.walk + '分'))
                .append($('<img class="samune">').attr({'src' : result.image_url.shop_image1}))
                // .append(('<div id="maps'+i+'"></div>'))

                );
               initMap();

              }
            },
            'jsonp'
          );
        })
      }
        function initMap() {
        var map = new google.maps.Map(document.getElementById("maps"), { // #mapに地図を埋め込む
           center: new google.maps.LatLng(lat, lng), // 地図の中心を指定
           zoom: 19, // 地図のズームを指定
         });

        var marker = new google.maps.Marker({ // マーカーの追加
        position: new google.maps.LatLng(lat, lng), // マーカーを立てる位置を指定
        map: map, // マーカーを立てる地図を指定
       });
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCrPF_PJ5nFAKmYx2k7-Cpxxptq9FVdejs&v=3.24"></script>

  </body>
</html>
